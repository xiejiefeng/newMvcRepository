(function(b){function a(f,d){var g=this,c=f.attr("name")||d.name||"";f.parent().hide();var e=f.css("width");f.parent().show();if(e=="0px"){e=f.outerWidth()+20}this.$el=f.hide();this.options=d;this.$parent=b("<div"+b.map(["class","title"],function(h){var i=g.$el.attr(h)||"";i=(h==="class"?("ms-parent"+(i?" ":"")):"")+i;return i?(" "+h+'="'+i+'"'):""}).join("")+" />");this.$choice=b('<button type="button" class="ms-choice"><span class="placeholder">'+d.placeholder+"</span><div></div></button>");this.$drop=b('<div class="ms-drop '+d.position+'"></div>');this.$el.after(this.$parent);this.$parent.append(this.$choice);this.$parent.append(this.$drop);if(this.$el.prop("disabled")){this.$choice.addClass("disabled")}this.$parent.css("width",d.width||e);if(!this.options.keepOpen){b("body").click(function(h){if(b(h.target)[0]===g.$choice[0]||b(h.target).parents(".ms-choice")[0]===g.$choice[0]){return}if((b(h.target)[0]===g.$drop[0]||b(h.target).parents(".ms-drop")[0]!==g.$drop[0])&&g.options.isOpen){g.close()}})}this.selectAllName='name="selectAll'+c+'"';this.selectGroupName='name="selectGroup'+c+'"';this.selectItemName='name="selectItem'+c+'"'}a.prototype={constructor:a,init:function(){var d=this,c=[];if(this.options.filter){c.push('<div class="ms-search">','<input type="text" autocomplete="off" autocorrect="off" autocapitilize="off" spellcheck="false">',"</div>")}c.push("<ul>");if(this.options.selectAll&&!this.options.single){c.push('<li class="ms-select-all">',"<label>",'<input type="checkbox" '+this.selectAllName+" /> ",this.options.selectAllDelimiter[0]+this.options.selectAllText+this.options.selectAllDelimiter[1],"</label>","</li>")}b.each(this.$el.children(),function(e,f){c.push(d.optionToHtml(e,f))});c.push('<li class="ms-no-results">'+this.options.noMatchesFound+"</li>");c.push("</ul>");this.$drop.html(c.join(""));this.$drop.find("ul").css("max-height",this.options.maxHeight+"px");this.$drop.find(".multiple").css("width",this.options.multipleWidth+"px");this.$searchInput=this.$drop.find(".ms-search input");this.$selectAll=this.$drop.find("input["+this.selectAllName+"]");this.$selectGroups=this.$drop.find("input["+this.selectGroupName+"]");this.$selectItems=this.$drop.find("input["+this.selectItemName+"]:enabled");this.$disableItems=this.$drop.find("input["+this.selectItemName+"]:disabled");this.$noResults=this.$drop.find(".ms-no-results");this.events();this.updateSelectAll(true);this.update(true);if(this.options.isOpen){this.open()}},optionToHtml:function(r,f,j,m){var g=this,p=b(f),k=[],t=this.options.multiple,q=["class","title"],d=b.map(q,function(v,x){var y=v==="class"&&t;var w=p.attr(v)||"";return(y||w)?(" "+v+'="'+(y?("multiple"+(w?" ":"")):"")+w+'"'):""}).join(""),e,c=this.options.single?"radio":"checkbox";if(p.is("option")){var o=p.val(),l=g.options.textTemplate(p),n=(g.$el.attr("multiple")!=undefined)?p.prop("selected"):(p.attr("selected")=="selected"),s=this.options.styler(o)?' style="'+this.options.styler(o)+'"':"";e=m||p.prop("disabled");if((this.options.blockSeparator>"")&&(this.options.blockSeparator==p.val())){k.push("<li"+d+s+">",'<label class="'+this.options.blockSeparator+(e?"disabled":"")+'">',l,"</label>","</li>")}else{k.push("<li"+d+s+">","<label"+(e?' class="disabled"':"")+">",'<input type="'+c+'" '+this.selectItemName+' value="'+o+'"'+(n?' checked="checked"':"")+(e?' disabled="disabled"':"")+(j?' data-group="'+j+'"':"")+"/> ",l,"</label>","</li>")}}else{if(!j&&p.is("optgroup")){var u="group_"+r,h=p.attr("label");e=p.prop("disabled");k.push('<li class="group">','<label class="optgroup'+(e?" disabled":"")+'" data-group="'+u+'">',(this.options.hideOptgroupCheckboxes?"":'<input type="checkbox" '+this.selectGroupName+(e?' disabled="disabled"':"")+" /> "),h,"</label>","</li>");b.each(p.children(),function(v,w){k.push(g.optionToHtml(v,w,u,e))})}}return k.join("")},events:function(){var e=this;function c(f){f.preventDefault();e[e.options.isOpen?"close":"open"]()}var d=this.$el.parent().closest("label")[0]||b("label[for="+this.$el.attr("id")+"]")[0];if(d){b(d).off("click").on("click",function(f){if(f.target.nodeName.toLowerCase()!=="label"||f.target!==this){return}c(f);if(!e.options.filter||!e.options.isOpen){e.focus()}f.stopPropagation()})}this.$choice.off("click").on("click",c).off("focus").on("focus",this.options.onFocus).off("blur").on("blur",this.options.onBlur);this.$parent.off("keydown").on("keydown",function(f){switch(f.which){case 27:e.close();e.$choice.focus();break}});this.$searchInput.off("keydown").on("keydown",function(f){if(f.keyCode===9&&f.shiftKey){e.close()}}).off("keyup").on("keyup",function(f){if(e.options.filterAcceptOnEnter&&(f.which===13||f.which==32)&&e.$searchInput.val()){e.$selectAll.click();e.close();e.focus();return}e.filter()});this.$selectAll.off("click").on("click",function(){var f=b(this).prop("checked"),g=e.$selectItems.filter(":visible");if(g.length===e.$selectItems.length){e[f?"checkAll":"uncheckAll"]()}else{e.$selectGroups.prop("checked",f);g.prop("checked",f);e.options[f?"onCheckAll":"onUncheckAll"]();e.update()}});this.$selectGroups.off("click").on("click",function(){var h=b(this).parent().attr("data-group"),i=e.$selectItems.filter(":visible"),f=i.filter('[data-group="'+h+'"]'),g=f.length!==f.filter(":checked").length;f.prop("checked",g);e.updateSelectAll();e.update();e.options.onOptgroupClick({label:b(this).parent().text(),checked:g,children:f.get()})});this.$selectItems.off("click").on("click",function(){e.updateSelectAll();e.update();e.updateOptGroupSelect();e.options.onClick({label:b(this).parent().text(),value:b(this).val(),checked:b(this).prop("checked")});if(e.options.single&&e.options.isOpen&&!e.options.keepOpen){e.close()}})},open:function(){if(this.$choice.hasClass("disabled")){return}this.options.isOpen=true;this.$choice.find(">div").addClass("open");this.$drop.show();this.$selectAll.parent().show();this.$noResults.hide();if(this.$el.children().length===0){this.$selectAll.parent().hide();this.$noResults.show()}if(this.options.container){var c=this.$drop.offset();this.$drop.appendTo(b(this.options.container));this.$drop.offset({top:c.top,left:c.left})}if(this.options.filter){this.$searchInput.val("");this.$searchInput.focus();this.filter()}this.options.onOpen();if(b().uniform&&this.options.uniform){this.$drop.find(":checkbox").uniform()}},close:function(){this.options.isOpen=false;this.$choice.find(">div").removeClass("open");this.$drop.hide();if(this.options.container){this.$parent.append(this.$drop);this.$drop.css({top:"auto",left:"auto"})}this.options.onClose()},update:function(e){var d=this.getSelects(),c=this.$choice.find(">span");if(d.length===0){c.addClass("placeholder").html(this.options.placeholder)}else{if(this.options.countSelected&&d.length<this.options.minimumCountSelected){c.removeClass("placeholder").html((this.options.displayValues?d:this.getSelects("text")).join(this.options.delimiter))}else{if(this.options.allSelected&&d.length===this.$selectItems.length+this.$disableItems.length){c.removeClass("placeholder").html(this.options.allSelected)}else{if((this.options.countSelected||this.options.etcaetera)&&d.length>this.options.minimumCountSelected){if(this.options.etcaetera){c.removeClass("placeholder").html((this.options.displayValues?d:this.getSelects("text").slice(0,this.options.minimumCountSelected)).join(this.options.delimiter)+"...")}else{c.removeClass("placeholder").html(this.options.countSelected.replace("#",d.length).replace("%",this.$selectItems.length+this.$disableItems.length))}}else{c.removeClass("placeholder").html((this.options.displayValues?d:this.getSelects("text")).join(this.options.delimiter))}}}}this.$el.val(this.getSelects());this.$drop.find("li").removeClass("selected");this.$drop.find("input["+this.selectItemName+"]:checked").each(function(){b(this).parents("li").first().addClass("selected")});if(!e){this.$el.trigger("change")}},updateSelectAll:function(c){var d=this.$selectItems;if(!c){d=d.filter(":visible")}this.$selectAll.prop("checked",d.length&&d.length===d.filter(":checked").length);if(this.$selectAll.prop("checked")){this.options.onCheckAll()}},updateOptGroupSelect:function(){var c=this.$selectItems.filter(":visible");b.each(this.$selectGroups,function(e,g){var f=b(g).parent().attr("data-group"),d=c.filter('[data-group="'+f+'"]');b(g).prop("checked",d.length&&d.length===d.filter(":checked").length)})},getSelects:function(d){var e=this,f=[],c=[];this.$drop.find("input["+this.selectItemName+"]:checked").each(function(){f.push(b(this).parents("li").first().text());c.push(b(this).val())});if(d==="text"&&this.$selectGroups.length){f=[];this.$selectGroups.each(function(){var i=[],l=b.trim(b(this).parent().text()),k=b(this).parent().data("group"),g=e.$drop.find("["+e.selectItemName+'][data-group="'+k+'"]'),h=g.filter(":checked");if(h.length===0){return}i.push("[");i.push(l);if(g.length>h.length){var j=[];h.each(function(){j.push(b(this).parent().text())});i.push(": "+j.join(", "))}i.push("]");f.push(i.join(""))})}return d==="text"?f:c},setSelects:function(c){var d=this;this.$selectItems.prop("checked",false);b.each(c,function(e,f){d.$selectItems.filter('[value="'+f+'"]').prop("checked",true)});this.$selectAll.prop("checked",this.$selectItems.length===this.$selectItems.filter(":checked").length);this.update()},enable:function(){this.$choice.removeClass("disabled")},disable:function(){this.$choice.addClass("disabled")},checkAll:function(){this.$selectItems.prop("checked",true);this.$selectGroups.prop("checked",true);this.$selectAll.prop("checked",true);this.update();this.options.onCheckAll();if(b().uniform&&this.options.uniform){this.$drop.find(":checkbox").uniform()}},uncheckAll:function(){this.$selectItems.prop("checked",false);this.$selectGroups.prop("checked",false);this.$selectAll.prop("checked",false);this.update();this.options.onUncheckAll();if(b().uniform&&this.options.uniform){this.$drop.find(":checkbox").uniform()}},focus:function(){this.$choice.focus();this.options.onFocus()},blur:function(){this.$choice.blur();this.options.onBlur()},refresh:function(){this.init()},filter:function(){var c=this,d=b.trim(this.$searchInput.val()).toLowerCase();if(d.length===0){this.$selectItems.parent().show();this.$disableItems.parent().show();this.$selectGroups.parent().show()}else{this.$selectItems.each(function(){var e=b(this).parent();e[e.text().toLowerCase().indexOf(d)<0?"hide":"show"]()});this.$disableItems.parent().hide();this.$selectGroups.each(function(){var f=b(this).parent();var e=f.attr("data-group"),g=c.$selectItems.filter(":visible");f[g.filter('[data-group="'+e+'"]').length===0?"hide":"show"]()});if(this.$selectItems.filter(":visible").length){this.$selectAll.parent().show();this.$noResults.hide()}else{this.$selectAll.parent().hide();this.$noResults.show()}}this.updateOptGroupSelect();this.updateSelectAll()}};b.fn.multipleSelect=function(){var e=arguments[0],d=arguments,f,c=["getSelects","setSelects","enable","disable","checkAll","uncheckAll","focus","blur","refresh"];this.each(function(){var i=b(this),h=i.data("multipleSelect"),g=b.extend({},b.fn.multipleSelect.defaults,i.data(),typeof e==="object"&&e);if(!h){h=new a(i,g);i.data("multipleSelect",h)}if(typeof e==="string"){if(b.inArray(e,c)<0){throw"Unknown method: "+e}f=h[e](d[1])}else{h.init();if(d[1]){f=h[d[1]].apply(h,[].slice.call(d,2))}}});return f?f:this};b.fn.multipleSelect.defaults={name:"",isOpen:false,placeholder:"",selectAll:true,selectAllText:"全选",selectAllDelimiter:["[","]"],allSelected:"全部",minimumCountSelected:10,countSelected:"已选择 # 项，共 % 项",noMatchesFound:"暂无可选项",multiple:false,multipleWidth:80,single:false,filter:false,width:"100%",maxHeight:250,container:null,position:"bottom",keepOpen:false,blockSeparator:"",displayValues:false,delimiter:", ",uniform:true,styler:function(){return false},textTemplate:function(c){return c.text()},onOpen:function(){return false},onClose:function(){return false},onCheckAll:function(){return false},onUncheckAll:function(){return false},onFocus:function(){return false},onBlur:function(){return false},onOptgroupClick:function(){return false},onClick:function(){return false}}})(jQuery);