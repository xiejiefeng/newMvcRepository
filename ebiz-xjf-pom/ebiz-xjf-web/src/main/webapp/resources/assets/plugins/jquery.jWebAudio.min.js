var jWebAudio=function(){if(window.hasOwnProperty("AudioContext")){this.context=new AudioContext()}else{if(window.hasOwnProperty("webkitAudioContext")){this.context=new webkitAudioContext()}else{this.context=null;console.error("Web audio is not supported in current web browser. Please try with the latest Chrome.")}}};jWebAudio=new jWebAudio();jWebAudio.SoundEngine=function(){this.soundArray=[]};jWebAudio.SoundEngine.prototype={addSoundSource:function(b){if(typeof b!=="object"||!b.hasOwnProperty("url")){console.error("Error url in addSoundSource.");return}if(b.preLoad!==true){b.preLoad=false}if(typeof b.callback!=="function"&&typeof b.callback!=="object"){b.callback=null}if(b.multishot!==true){b.multishot=false}if(typeof b.url==="string"){this.soundArray.push(new jWebAudio.SoundSource(this.soundArray.length,b));return this.soundArray[this.soundArray.length-1]}else{if(typeof b.url==="object"){if(b.preLoad){var a=b.url.length;var d=0;var g=b.callback;b.callback=function(){++d;if(d===a){if(g){g()}}}}var h=this.soundArray.length;var f=b.url.slice();for(var c in b.url){b.url=f[c];this.soundArray.push(new jWebAudio.SoundSource(this.soundArray.length,b))}var e=[];for(var c=h;c<this.soundArray.length;++c){e[c-h]=this.soundArray[c]}return e}}},destroySound:function(a){if(this.soundArray[a]){if(this.soundArray[a].isLoaded){this.soundArray[a].stop()}delete this.soundArray[a]}}};jWebAudio.SoundSource=function(c,b){this.id=b.id;this.url=b.url;this.multishot=b.multishot;this.isLoaded=false;this.options=b;this.finish=b.finish;var a=this;this.sound=null;if(b.preLoad===true){this.load(b.callback)}};jWebAudio.SoundSource.prototype.load=function(c){if(!this.isLoaded){var b=new XMLHttpRequest();b.open("GET",this.url,true);b.responseType="arraybuffer";var a=this;b.onload=function(){jWebAudio.context.decodeAudioData(b.response,function(d){if(a.multishot){a.sound=new jWebAudio.WebAudioMultishotSound(d)}else{a.sound=new jWebAudio.WebAudioSound(d,a.finish)}a.sound.options=a.options;a.isLoaded=true;if(c){c()}return true},function(){console.error("Cannot decode: "+a.url);return false})};b.onerror=function(){console.error("Load error")};b.send()}};jWebAudio.extend=function(b,a){var c=function(){};c.prototype=a.prototype;b.prototype=new c();b.prototype.constructor=b};jWebAudio.leftMerge=function(c,b){for(var a in b){if(c.hasOwnProperty(a)){if(typeof c[a]==="object"){if(typeof b[a]==="object"){leftMerge(c[a],b[a])}}else{c[a]=b[a]}}}};jWebAudio.Sound=function(){this.STOPPED=0;this.PLAYING=1;this.PAUSED=2;var c=3;var d=3;var h=this;var j={loop:false,loopGap:0,muted:false,volume:100,fadeIn:false,fadeOut:false,fadeInTime:c,fadeOutTime:d};this.getOptions=function(){return j};this.__defineGetter__("options",this.getOptions);this.setOptions=function(k){if(k){if(typeof k.muted==="boolean"&&k.muted!==j.muted){h.setMuted(k.muted)}if(typeof k.volume==="number"&&k.volume!==j.volume){h.setVolume(k.volume)}if(typeof k.fadeIn==="boolean"){j.fadeIn=k.fadeIn;h.setFadeIn(j.fadeIn,k.fadeInTime)}if(typeof k.fadeOut==="boolean"){j.fadeOut=k.fadeOut;h.setFadeOut(j.fadeOut,k.fadeOutTime)}jWebAudio.leftMerge(j,k)}};this.__defineSetter__("options",this.setOptions);this.setMuted=function(k){if(typeof k!=="boolean"){console.error("Error type of mute!");return}j.muted=k;if(k){g.gain.value=0}else{g.gain.value=j.volume/100}};this.getMuted=function(k){return h.options.muted};this.setVolume=function(k){k=+k;if(isNaN(k)){console.error("Error type of volume in setVolume");return}j.volume=k;g.gain.value=k/100};this.getVolume=function(){return h.options.volume};this.getLoop=function(){return h.options.loop};var i=jWebAudio.context;var g=i.createGain();this.__defineGetter__("gain",function(){return g});var b=[];var f=[];this.addEffect=function(k){if(typeof k==="string"){k=new jWebAudio.Effect(k)}if(!(k instanceof jWebAudio.Effect)){console.error("Error in addEffect: effect is not instance of Effect");return}var m=a();var l=e();if(m!==null){l.outNode.disconnect();l.outNode.connect(k.inNode)}else{g.disconnect();g.connect(k.inNode)}k.outNode.connect(i.destination);b.push(k);f.push(k.getName());return b.length-1};this.getEffectNames=function(){return f};this.getEffect=function(k){return b[k]};this.deleteEffect=function(n){if(b[n]!==undefined){var m=null;for(var l=n-1;l>=0;--l){if(b[l]!==undefined){m=b[l].outNode;break}}var k=i.destination;for(var l=n+1;l<b.length;++l){if(b[l]!==undefined){k=b[l].inNode;break}}if(m===null){g.disconnect();g.connect(k)}else{m.disconnect();m.connect(k)}delete b[n];delete f[n]}};this.clearAllEffects=function(){for(var k=b.length-1;k>=0;--k){if(b[k]!==undefined){g.disconnect();b[k].outNode.disconnect();g.connect(i.destination);b=[];f=[];return}}};function a(){for(var k=0;k<b.length;++k){if(b[k]!==undefined){return b[k]}}return null}function e(){for(var k=b.length-1;k>=0;--k){if(b[k]!==undefined){return b[k]}}return null}g.connect(i.destination)};jWebAudio.WebAudioSound=function(f,g){jWebAudio.Sound.call(this);var o=this;var b=jWebAudio.context;var j=b.createGain();j.connect(o.gain);var i=null;var m=f;this.__defineGetter__("duration",function(){return m.duration});var n=0;this.__defineGetter__("offset",function(){if(d===o.PLAYING){return(b.currentTime-a+n)}return n});this.seek=function(p){if(typeof p!=="number"||p<0||p>m.duration){console.error("Error arg in WebAudioSound.");return}var q=d;k();n=p;if(q===this.PLAYING){c()}};var a=0;var d=this.STOPPED;this.__defineGetter__("state",function(){return d});var h=null;var e=null;var l=null;this.play=function(){if(d===o.PLAYING){return}c()};function c(){var r=m.duration-n;i=b.createBufferSource();i.buffer=m;i.loop=o.options.loop;i.connect(j);if(o.options.fadeIn){j.gain.setValueAtTime(j.gain.minValue,b.currentTime);j.gain.linearRampToValueAtTime(j.gain.maxValue,b.currentTime+o.options.fadeInTime)}i.start(0,n,r);a=b.currentTime;d=o.PLAYING;var p=function(){return setTimeout(function(){if(o.options.loop===true){o.seek(0);if(o.options.loopGap&&o.options.loopGap>0){o.stop();loopGapEvent=setTimeout(function(){c()},o.options.loopGap*1000)}}else{n=0;d=o.STOPPED}if(g){g()}},r*1000)};h=p();if(o.options.fadeOut===true){var q=function(){return setTimeout(function(){j.gain.setValueAtTime(j.gain.maxValue,b.currentTime);j.gain.linearRampToValueAtTime(j.gain.minValue,b.currentTime+o.options.fadeOutTime)},(r-o.options.fadeOutTime)*1000)};e=q()}}this.pause=function(){if(d!==o.PLAYING){return}k();d=o.PAUSED};this.stop=function(){if(d===o.STOPPED){return}function p(){k();n=0;d=o.STOPPED}if(o.options.fadeOut){var q=o.options.fadeOutTime;j.gain.linearRampToValueAtTime(j.gain.minValue,b.currentTime+q);setTimeout(function(){p()},q*1000)}else{p()}};function k(){if(d===o.PLAYING){i.stop();i=null;n+=(b.currentTime-a);clearTimeout(h);clearTimeout(e)}}this.setFadeIn=function(p,q){if(typeof p==="boolean"){o.options.fadeIn=p;if(typeof q==="number"){o.options.fadeInTime=q}}else{o.options.fadeOut=ifFadeOut;console.error("Error type in setFadeIn.")}};this.setFadeOut=function(p,q){if(typeof p==="boolean"){if(typeof q==="number"){o.options.fadeOutTime=q}}}};jWebAudio.extend(jWebAudio.WebAudioSound,jWebAudio.Sound);jWebAudio.WebAudioMultishotSound=function(a){jWebAudio.Sound.call(this);var c=jWebAudio.context;var d=a;var e=[];var b=this;this.play=function(){var f=c.createBufferSource();f.buffer=d;f.loop=this.loop;f.connect(b.gain);f.start();e.push(f)};this.stop=function(){e.forEach(function(f){f.stop();f.disconnect()});e=[]}};jWebAudio.extend(jWebAudio.WebAudioMultishotSound,jWebAudio.Sound);jWebAudio.Effect=function(a){if(a==="telephonize"){return new jWebAudio.Filter(a,[{type:jWebAudio.Filter.prototype.LOWPASS,frequency:2000},{type:jWebAudio.Filter.prototype.HIGHPASS,frequency:500}])}else{if(a==="cathedral"){return new jWebAudio.Filter(a,[{type:jWebAudio.Filter.prototype.BANDPASS,frequency:3000},{type:jWebAudio.Filter.prototype.ALLPASS,frequency:1000}])}else{if(a==="3d"){return new jWebAudio.Spatiality()}else{console.error('Effect name: "'+a+'" not found')}}}};jWebAudio.Filter=function(a,l){var h=a;this.getName=function(){return h};var g,f,e=[],c,b,d=[];if(l instanceof Array){e=l}else{if(l instanceof Object){e.push(l)}else{return}}var k=jWebAudio.context;for(g=0;g<e.length;++g){c=e[g];if(c.type>=0&&c.type<=7){b=k.createBiquadFilter();b.type=c.type;b.frequency.value=c.frequency;b.Q.value=c.Q;b.gain.value=c.gain;d.push(b)}}for(g=0;g<d.length-1;++g){f=g+1;d[g].connect(d[f])}this.__defineGetter__("inNode",function(){return d[0]});this.__defineGetter__("outNode",function(){return d[d.length-1]})};jWebAudio.extend(jWebAudio.Filter,jWebAudio.Effect);jWebAudio.Filter.prototype.LOWPASS=0;jWebAudio.Filter.prototype.HIGHPASS=1;jWebAudio.Filter.prototype.BANDPASS=2;jWebAudio.Filter.prototype.LOWSHELF=3;jWebAudio.Filter.prototype.HIGHSHELF=4;jWebAudio.Filter.prototype.PEAKING=5;jWebAudio.Filter.prototype.NOTCH=6;jWebAudio.Filter.prototype.ALLPASS=7;jWebAudio.Spatiality=function(){var a=jWebAudio.context;this.soundObject=a.createPanner();var b=this;this.__defineGetter__("inNode",function(){return b.soundObject});this.__defineGetter__("outNode",function(){return b.soundObject})};jWebAudio.extend(jWebAudio.Spatiality,jWebAudio.Effect);jWebAudio.Spatiality.prototype.getName=function(){return"3d"};(function(c){if(jWebAudio===undefined){c.error("Please include standard.jWebAudio.js first!");return}var b=new jWebAudio.SoundEngine();var a={addSoundSource:function(d){return this.each(function(){if(a.existsSound.call(c(this))){console.warn("Sound already exists. It will be destroyed now.");a.destroySound.call(c(this))}if(typeof d.url!=="string"){c.error("Error type of url!");return}c(this).data("soundId",b.soundArray.length);b.addSoundSource(d)})},destroySound:function(){return this.each(function(){var d=c(this).data("soundId");b.destroySound(d)})},existsSound:function(){if(c(this).data("soundId")===undefined){return false}else{return true}},load:function(d){return this.each(function(){if(c(this).data("soundId")!==undefined){var e=c(this).data("soundId")}else{c.error("Please call addSoundSource first!");return}b.soundArray[e].load(d)})},play:function(){return this.each(function(){if(c(this).data("soundId")!==undefined){var d=c(this).data("soundId")}else{c.error("Please call addSoundSource first!");return}b.soundArray[d].sound.play()})},pause:function(){return this.each(function(){if(c(this).data("soundId")!==undefined){var d=c(this).data("soundId")}else{c.error("Please call addSoundSource first!");return}b.soundArray[d].sound.pause()})},stop:function(){return this.each(function(){if(c(this).data("soundId")!==undefined){var d=c(this).data("soundId")}else{c.error("Please call addSoundSource first!");return}b.soundArray[d].sound.stop()})},seek:function(d){if(c(this).data("soundId")!==undefined){var f=c(this).data("soundId")}else{c.error("Please call addSoundSource first!");return}var e=b.soundArray[f].sound;if(e.options.multishot){c.error("You cannot call seek with multishot sound!");return}if(d===undefined){return e.offset}else{return this.each(function(){e.seek(d)})}},duration:function(){if(c(this).data("soundId")!==undefined){var e=c(this).data("soundId")}else{c.error("Please call addSoundSource first!");return}var d=b.soundArray[e].sound;if(d.options.multishot){c.error("You cannot get duration with multishot sound!");return}return d.duration},finish:function(d){return this.each(function(){if(c(this).data("soundId")!==undefined){var e=c(this).data("soundId")}else{c.error("Please call addSoundSource first!");return}if(d&&typeof d!=="function"){c.error("Error type of finish!")}else{b.soundArray[e].finish=d}})},addEffect:function(d){if(c(this).data("soundId")!==undefined){var f=c(this).data("soundId")}else{c.error("Please call addSoundSource first!");return}var e=b.soundArray[f].sound;if(typeof d==="string"){return e.addEffect(d)}else{if(typeof d==="object"&&d.name!==undefined&&d.options!==undefined){return e.addEffect(new jWebAudio.Filter(d.name,d.options))}else{c.error("Error type of effect!")}}},deleteEffect:function(d){return this.each(function(){if(c(this).data("soundId")!==undefined){var e=c(this).data("soundId")}else{c.error("Please call addSoundSource first!");return}var g=b.soundArray[e].sound;if(typeof d==="number"){g.deleteEffect(d)}else{if(typeof d==="object"){for(var f in d){g.deleteEffect(d[f])}}}})},getEffect:function(e){if(c(this).data("soundId")!==undefined){var d=c(this).data("soundId")}else{c.error("Please call addSoundSource first!");return}if(typeof e==="number"){return b.soundArray[d].sound.getEffect(e)}else{c.error("Error type in set3dEffectPosition!")}},clearAllEffects:function(){return this.each(function(){if(c(this).data("soundId")!==undefined){var d=c(this).data("soundId")}else{c.error("Please call addSoundSource first!");return}b.soundArray[d].sound.clearAllEffects()})},options:function(d){if(d===undefined){var e=c(this).data("soundId");return b.soundArray[e].sound.options}else{return this.each(function(){if(c(this).data("soundId")!==undefined){var f=c(this).data("soundId")}else{c.error("Please call addSoundSource first!");return}b.soundArray[f].sound.options=d})}}};c.fn.jWebAudio=function(){var e=arguments[0];if(a[e]){if(arguments[1]===undefined){return a[e].call(this)}else{if(typeof arguments[1]==="object"){var d=c.extend({callback:function(){}},arguments[1]);if(typeof arguments[2]==="function"){c.extend(d,{callback:arguments[2]})}}else{var d=arguments[1]}return a[e].call(this,d)}}else{if(typeof e==="object"||!e){var d=c.extend({callback:function(){}},arguments[0]||{});if(typeof arguments[1]==="function"){c.extend(d,{callback:arguments[1]})}return a.init.call(this,d)}else{c.error("Method "+e+" does not exist on jquery.jWebAudio")}}}})(jQuery);